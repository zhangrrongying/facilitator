<form id="exportform" class="form-horizontal" role="form" data-toggle="validator">
    <div class="form-group row">
        <div class="col-md-3 text-right"><label>供应商：</label></div>
        <div class="col-md-8" id="farmName" th:inline="text">[[${project.supplierName}]]</div>
    </div>
    <div class="form-group row">
        <div class="col-md-3 text-right"><label>中标项目：</label></div>
        <div class="col-md-8" th:inline="text">[[${project.name}]]</div>
    </div>
    <div class="form-group row">
        <div class="col-md-3 text-right"><label>项目简介：</label></div>
        <div class="col-md-8" id="description_1" th:inline="text">[[${project.description}]]</div>
    </div>
</form>
<div class="jqGrid_wrapper" style="height:250px; overflow:auto">
	<table id="table_list"></table>
</div>
<script type="text/javascript" th:inline="text">
    //<![CDATA[
   var projectScores = new Array();
   var projectId = [[${projectId}]];
   $(function () {
	   var form = $("#exportform");
	   loadFarmlist();
	   sykModal.submit = {
	            url: '/project/score/save.json',
	            data: function () {
	                return projectScores;
	            },
	            done: function (ret) {
	                if (!ret.result) {
	                    layer.alert("导出失败：{" + ret.msg + "}");
	                } else {
	                syk.refresh();
	                    sykModal.close();
	                }
	            }
	        };
    });         
   function loadFarmlist(){
	   var tab = $("#table_list").jqGrid({
           datatype: function (postdata) {
           	$("#table_list").setGridWidth(740);
               jQuery.ajax({
                   type: 'GET',
                   contentType: 'application/json',
                   url: '/project/score.json',
                   success: function (resp) {
                       $("#table_list")[0].addJSONData(resp);
                   },
                   error: function (errMsg) {
                       layer.alert("<spn style='color:red'>发生系统错误，加载失败</spn>");
                   }
               });
           },
           height: '100%',
           jsonReader: {
               repeatitems: false
           },
           multiselect: false,
           viewrecords: true,
           hidegrid: false,
           colNames: ['评价指标', '内容','评分'],
           colModel: [
                      { name: 'name', index: 'name', width: 60, align: "center", sortable: false, 
                    	  cellattr: function(rowId, tv, rawObject, cm, rdata) {
                          //合并单元格
                  		  return 'id=\'name' + rowId + "\'";
                      }},
                      { name: 'description', index: 'description', width: 130, align: "center", sortable: false },
                      { name: 'operate', index: 'operate', align: "center", width: 60, sortable: false,formatter: addScroe }
           ],
           gridComplete: function () {
        	   var gridTable = $("#table_list");
               Merger(gridTable, 'name');
           }
       });
    }
   function Merger(gridTable, CellName) {
       //得到显示到界面的id集合
       var mya = gridTable.getDataIDs();
       //当前显示多少条
       var length = mya.length;
       for (var i = 0; i < length; i++) {
           //从上到下获取一条信息
           var before = gridTable.jqGrid('getRowData', mya[i]);
           //定义合并行数
           var rowSpanTaxCount = 1;
           for (j = i + 1; j <= length; j++) {
               //和上边的信息对比 如果值一样就合并行数+1 然后设置rowspan 让当前单元格隐藏
               var end = gridTable.jqGrid('getRowData', mya[j]);
               if (before[CellName] == end[CellName]) {
                   rowSpanTaxCount++;
                   gridTable.setCell(mya[j], CellName, '', { display: 'none' });
               } else {
                   rowSpanTaxCount = 1;
                   break;
               }
               $("#" + CellName + "" + mya[i] + "").attr("rowspan", rowSpanTaxCount);
           }
           $('#star'+mya[i]).raty({ 
        	   score: 0,
        	   click: function(score, evt) {
        		   var id = this.id.replace("star","");
        		   for(i in projectScores){
        			   if(id == projectScores[i].id){
        				   projectScores.splice(i,1);
							i--;
						}
        		   }
        		   var projectScore = {};
        		   projectScore.projectId = projectId;
        		   projectScore.projectScoreId = id;
        		   projectScore.score = score;
        		   projectScores.push(projectScore);
        		  }
       	   });
       }
   }
   
   function addScroe(cellvalue, options, rowObject) {
       var cont = '<div id="star'+rowObject.id+'"></div>';
       return cont;
   }
    //]]>
</script>