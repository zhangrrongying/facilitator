<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE guzz-configs PUBLIC "-//GUZZ//DTD MAIN CONFIG//EN" "http://www.guzz.org/dtd/guzz.dtd">
<guzz-configs>
	<sqlMap dbgroup="facMysql">
		
		<select id="getMenusByUserId" orm="sysAuthFunc">
			<![CDATA[
			SELECT a.* FROM sys_auth_func a LEFT JOIN sys_role_func b ON a.Id = b.Func_Id LEFT JOIN sys_role c ON b.Role_Id = c.Id 
			LEFT JOIN sys_role_user d  ON c.Id = d.Role_Id WHERE d.User_Id = :userId ORDER BY a.Rank DESC
			]]>
		</select>
		
		<select orm="sysUser" id="findUserList"  templated="true">
		<![CDATA[
			SELECT a.id,a.userName,a.name,a.Email,a.Phone,a.status, e.Role_Id roleId,f.`Name` AS roleName,a.LoginNum FROM sys_user a 
			LEFT JOIN sys_role_user e ON a.Id = e.User_Id LEFT JOIN sys_role f ON e.Role_Id = f.Id  where 1=1  
	        #notEmpty($name)
	           AND a.name like '%$name%'
	        #end
	        #notEmpty($userName)
	           AND a.userName =:userName 
	        #end
			#notEmpty($roleId)
	           AND e.Role_Id =:roleId 
	        #end
			GROUP BY a.Id 
			limit :start,:end
			]]>
		</select>
		<select orm="jqresp" id="getUserCount" templated="true">
			<![CDATA[
				SELECT count(1) records from (SELECT count(1) records FROM sys_user a 
				LEFT JOIN sys_role_user e ON a.Id = e.User_Id LEFT JOIN sys_role f ON e.Role_Id = f.Id 
		          where 1=1
		        #notEmpty($name)
		           AND a.name like '%$name%'
		        #end
		        #notEmpty($userName)
		           AND a.userName =:userName 
		        #end
				#notEmpty($roleId)
		           AND e.Role_Id =:roleId 
		        #end
		        GROUP BY a.Id ) a
			]]>
		</select>
		<select orm="sysUser" id="getSysUserById"  templated="true">
		<![CDATA[
			SELECT a.*,b.Role_Id AS roleId FROM sys_user a LEFT JOIN sys_role_user b ON a.Id = b.User_Id WHERE a.Id = :id
			]]>
		</select>
		<update orm="sysUser" id="updateUser" templated="true">
		<![CDATA[
			update sys_user a,sys_role_user r 
			set r.Role_Id=:roleId,a.UserName=:userName, a.Name=:name,a.Email=:email,a.Phone= :phone,a.Status=:status,a.Supplier_Id=:supplierId 
			WHERE  r.User_Id=a.Id AND a.Id=:id
		]]>
		</update>
		<update orm="sysUser" id="updatePwd">
		<![CDATA[
			update sys_user set Password = :password where id = :id 
			]]>
		</update>
		<select orm="loginLog" id="findLoginLogList"  templated="true">
		<![CDATA[
			SELECT * FROM login_log WHERE User_Id = :userId limit :start,:end
			]]>
		</select>
		<select orm="jqresp" id="getLoginLogCount" templated="true">
			<![CDATA[
				SELECT COUNT(1) records FROM login_log WHERE User_Id = :userId
			]]>
		</select>
		<select orm="sysRole" id="getRoleByUserId" templated="true">
			<![CDATA[
				SELECT a.* FROM sys_role a LEFT JOIN sys_role_user b ON a.Id = b.Role_Id WHERE b.User_Id = :userId
			]]>
		</select>
		<orm class="com.ec.facilitator.base.model.common.JQGridResponseModel" id="jqresp">
			<result column="records" property="records"/>
		</orm>
  	</sqlMap>
 </guzz-configs>